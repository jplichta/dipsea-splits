// Dipsea Race Data
// Head starts, groups, clock curves, split proportions, and checkpoint definitions.
// Sources: dipsea.org handicap table, 2025 race results (13,653 records),
// Strava segment data, user activity 2/14/2026.

/* exported D, CHECKPOINTS */
const D = {
  // Head start minutes by age — Male
  hs_m: {
    6:25, 7:21, 8:16, 9:13, 10:11, 11:9, 12:7, 13:6, 14:5, 15:4,
    16:3, 17:2, 18:1, 19:1, 20:0, 21:0, 22:0, 23:0, 24:0, 25:0,
    26:1, 27:1, 28:1, 29:1, 30:1, 31:1, 32:1, 33:2, 34:2, 35:2,
    36:2, 37:2, 38:2, 39:2, 40:2, 41:2, 42:3, 43:3, 44:3, 45:4,
    46:4, 47:4, 48:5, 49:5, 50:6, 51:6, 52:6, 53:6, 54:7, 55:7,
    56:8, 57:9, 58:10, 59:10, 60:11, 61:12, 62:13, 63:14, 64:14,
    65:15, 66:16, 67:17, 68:18, 69:19, 70:20, 71:22, 72:23, 73:24,
    74:25, 75:25, 76:25, 77:25, 78:25, 79:25, 80:25, 81:25, 82:25,
    83:25, 84:25, 85:25, 86:25, 87:25, 88:25, 89:25, 90:25, 91:25,
    92:25, 93:25, 94:25, 95:25, 96:25, 97:25, 98:25, 99:25, 100:25
  },

  // Head start minutes by age — Female
  hs_f: {
    6:25, 7:25, 8:23, 9:20, 10:16, 11:14, 12:13, 13:12, 14:12,
    15:12, 16:11, 17:11, 18:11, 19:11, 20:11, 21:11, 22:11, 23:11,
    24:11, 25:10, 26:9, 27:9, 28:9, 29:9, 30:9, 31:9, 32:9, 33:9,
    34:9, 35:9, 36:9, 37:9, 38:9, 39:9, 40:10, 41:10, 42:10, 43:10,
    44:11, 45:12, 46:12, 47:12, 48:12, 49:13, 50:13, 51:13, 52:14,
    53:15, 54:15, 55:16, 56:17, 57:17, 58:18, 59:19, 60:20, 61:20,
    62:21, 63:22, 64:23, 65:24, 66:25, 67:25, 68:25, 69:25, 70:25,
    71:25, 72:25, 73:25, 74:25, 75:25, 76:25, 77:25, 78:25, 79:25,
    80:25, 81:25, 82:25, 83:25, 84:25, 85:25, 86:25, 87:25, 88:25,
    89:25, 90:25, 91:25, 92:25, 93:25, 94:25, 95:25, 96:25, 97:25,
    98:25, 99:25, 100:25
  },

  // Handicap group by age — Male
  grp_m: {
    6:"AAA", 7:"C", 8:"H", 9:"L", 10:"N", 11:"Q", 12:"T", 13:"U",
    14:"V", 15:"W", 16:"X", 17:"Y", 18:"Z", 19:"Z", 20:"SCR", 21:"SCR",
    22:"SCR", 23:"SCR", 24:"SCR", 25:"SCR", 26:"Z", 27:"Z", 28:"Z",
    29:"Z", 30:"Z", 31:"Z", 32:"Z", 33:"Y", 34:"Y", 35:"Y", 36:"Y",
    37:"Y", 38:"Y", 39:"Y", 40:"Y", 41:"Y", 42:"X", 43:"X", 44:"X",
    45:"W", 46:"W", 47:"W", 48:"V", 49:"V", 50:"U", 51:"U", 52:"U",
    53:"U", 54:"T", 55:"T", 56:"R", 57:"Q", 58:"P", 59:"P", 60:"N",
    61:"M", 62:"L", 63:"K", 64:"K", 65:"J", 66:"H", 67:"G", 68:"F",
    69:"E", 70:"D", 71:"B", 72:"A", 73:"AA", 74:"AAA", 75:"AAA",
    76:"AAA", 77:"AAA", 78:"AAA", 79:"AAA", 80:"AAA", 81:"AAA",
    82:"AAA", 83:"AAA", 84:"AAA", 85:"AAA", 86:"AAA", 87:"AAA",
    88:"AAA", 89:"AAA", 90:"AAA", 91:"AAA", 92:"AAA", 93:"AAA",
    94:"AAA", 95:"AAA", 96:"AAA", 97:"AAA", 98:"AAA", 99:"AAA", 100:"AAA"
  },

  // Handicap group by age — Female
  grp_f: {
    6:"AAA", 7:"AAA", 8:"A", 9:"D", 10:"H", 11:"K", 12:"L", 13:"M",
    14:"M", 15:"M", 16:"N", 17:"N", 18:"N", 19:"N", 20:"N", 21:"N",
    22:"N", 23:"N", 24:"N", 25:"P", 26:"Q", 27:"Q", 28:"Q", 29:"Q",
    30:"Q", 31:"Q", 32:"Q", 33:"Q", 34:"Q", 35:"Q", 36:"Q", 37:"Q",
    38:"Q", 39:"Q", 40:"P", 41:"P", 42:"P", 43:"P", 44:"N", 45:"M",
    46:"M", 47:"M", 48:"M", 49:"L", 50:"L", 51:"L", 52:"K", 53:"J",
    54:"J", 55:"H", 56:"G", 57:"G", 58:"F", 59:"E", 60:"D", 61:"D",
    62:"C", 63:"B", 64:"A", 65:"AA", 66:"AAA", 67:"AAA", 68:"AAA",
    69:"AAA", 70:"AAA", 71:"AAA", 72:"AAA", 73:"AAA", 74:"AAA",
    75:"AAA", 76:"AAA", 77:"AAA", 78:"AAA", 79:"AAA", 80:"AAA",
    81:"AAA", 82:"AAA", 83:"AAA", 84:"AAA", 85:"AAA", 86:"AAA",
    87:"AAA", 88:"AAA", 89:"AAA", 90:"AAA", 91:"AAA", 92:"AAA",
    93:"AAA", 94:"AAA", 95:"AAA", 96:"AAA", 97:"AAA", 98:"AAA",
    99:"AAA", 100:"AAA"
  },

  // Reference clock times (seconds) for key placements
  clocks: {
    "1": 2788,
    "35": 3198,
    "100": 3531,
    "450": 4270,
    "750": 5865,
    "dr_winner": 4636
  },

  // Segment proportions at key placements (2025 band averages)
  // p1: Start→Muir Woods, p2: Muir Woods→Cardiac, p3: Cardiac→Stile, p4: Stile→Finish
  props: {
    "1":         { p1: 0.2967, p2: 0.3698, p3: 0.3032, p4: 0.0303 },
    "35":        { p1: 0.2942, p2: 0.3736, p3: 0.3035, p4: 0.0287 },
    "100":       { p1: 0.2888, p2: 0.3770, p3: 0.3058, p4: 0.0284 },
    "450":       { p1: 0.2822, p2: 0.3851, p3: 0.3053, p4: 0.0274 },
    "750":       { p1: 0.2890, p2: 0.3813, p3: 0.3028, p4: 0.0269 },
    "dr_winner": { p1: 0.2931, p2: 0.3682, p3: 0.3076, p4: 0.0311 }
  },

  // DR section offset: actual_time = clock_time + head_start - dr_offset
  dr_offset: 1621,

  // Terrain bias standard deviations (1 SD shift per bias unit)
  bias_p2_sd: 0.0144,
  bias_p3_sd: 0.0137,

  // Sub-split proportions (fraction through parent segment at each sub-checkpoint)
  // Derived from Strava segment data + user activity 2/14/2026
  sub: {
    top_stairs_in_p1: 0.384,      // Start → Top of Dipsea Stairs = 38.4% of p1 (corrected: Mill Valley Square start, not Old Mill Park)
    windy_gap_in_p1: 0.485,       // Start → Windy Gap = 48.5% of p1 (corrected: Mill Valley Square start, not Old Mill Park)
    dynamite_in_p2: 0.33,         // Muir Woods → top of Dynamite = 33% of p2
    bottom_cardiac_in_p2: 0.92,   // Muir Woods → bottom of Cardiac climb = 92% of p2
    steep_ravine_in_p3: 0.70      // Cardiac → Steep Ravine Bridge = 70% of p3
  },

  // Clock→place curve (every 5th place, 2025 results)
  curve_c: [
    2788, 2966, 3051, 3104, 3135, 3166, 3186, 3218, 3236, 3310,
    3342, 3361, 3392, 3410, 3426, 3452, 3463, 3487, 3506, 3515,
    3537, 3551, 3565, 3583, 3591, 3607, 3630, 3638, 3656, 3665,
    3678, 3697, 3713, 3720, 3730, 3737, 3746, 3756, 3771, 3783,
    3799, 3812, 3820, 3830, 3847, 3859, 3867, 3875, 3878, 3882,
    3890, 3904, 3919, 3926, 3937, 3947, 3953, 3962, 3973, 3981,
    3988, 4003, 4008, 4017, 4029, 4035, 4040, 4049, 4056, 4066,
    4076, 4085, 4094, 4111, 4118, 4130, 4139, 4144, 4149, 4159,
    4162, 4173, 4182, 4190, 4200, 4208, 4212, 4231, 4254, 4262,
    4270, 4288, 4302, 4312, 4327, 4333, 4348, 4365, 4370, 4377,
    4396, 4413, 4433, 4477, 4496, 4539, 4577, 4605, 4638, 4683,
    4717, 4737, 4801, 4978, 5000, 5073, 5112, 5192, 5263, 5285,
    5319, 5346, 5389, 5404, 5435, 5453, 5472, 5506, 5525, 5540,
    5568, 5589, 5611, 5620, 5635, 5642, 5666, 5686, 5696, 5704,
    5726, 5740, 5765, 5777, 5781, 5794, 5806, 5816, 5839, 5855,
    5866, 5894, 5914, 5922, 5929, 5946, 5966, 5989, 6000, 6014,
    6027, 6035, 6049, 6063, 6066, 6072, 6091, 6105, 6124, 6134,
    6148, 6153, 6168, 6189, 6202, 6214, 6219, 6224, 6237, 6250,
    6258, 6265, 6269, 6272, 6286, 6295, 6310, 6315, 6324, 6337,
    6362, 6372, 6382, 6402, 6412, 6424, 6431, 6458, 6481, 6493,
    6505, 6517, 6529, 6537, 6554, 6579, 6593, 6602, 6611, 6613,
    6618, 6624, 6634, 6639, 6643, 6647, 6654, 6660, 6672, 6683,
    6687, 6703, 6714, 6726, 6738, 6760, 6771, 6797, 6831, 6859,
    6876, 6890, 6903, 6913, 6928, 6938, 6946, 6966, 6977, 7001,
    7021, 7031, 7049, 7075, 7088, 7111, 7120, 7145, 7168, 7183,
    7198, 7225, 7257, 7280, 7299, 7312, 7319, 7355, 7419, 7447,
    7468, 7493, 7520, 7562, 7590, 7601, 7626, 7668, 7691, 7728,
    7755, 7765, 7841, 7889, 7941, 7988, 8064, 8104, 8128, 8180,
    8262, 8337, 8375, 8448, 8512, 8535, 8624, 8647, 8673, 8697,
    8746, 8787, 8825, 8969, 9165, 9261, 9357, 9504, 9740, 10819,
    12322, 13610
  ],

  // Place values corresponding to curve_c
  curve_p: [
    1, 6, 11, 16, 21, 26, 31, 36, 41, 46, 51, 56, 61, 66, 71,
    76, 81, 86, 91, 96, 101, 106, 111, 116, 121, 126, 131, 136,
    141, 146, 151, 156, 161, 166, 171, 176, 181, 186, 191, 196,
    201, 206, 211, 216, 221, 226, 231, 236, 241, 246, 251, 256,
    261, 266, 271, 276, 281, 286, 291, 296, 301, 306, 311, 316,
    321, 326, 331, 336, 341, 346, 351, 356, 361, 366, 371, 376,
    381, 386, 391, 396, 401, 406, 411, 416, 421, 426, 431, 436,
    441, 446, 451, 456, 461, 466, 471, 476, 481, 486, 491, 496,
    501, 506, 511, 516, 521, 526, 531, 536, 541, 546, 551, 556,
    561, 566, 571, 576, 581, 586, 591, 596, 601, 606, 611, 616,
    621, 626, 631, 636, 641, 646, 651, 656, 661, 666, 671, 676,
    681, 686, 691, 696, 701, 706, 711, 716, 721, 726, 731, 736,
    741, 746, 751, 756, 761, 766, 771, 776, 781, 786, 791, 796,
    801, 806, 811, 816, 821, 826, 831, 836, 841, 846, 851, 856,
    861, 866, 871, 876, 881, 886, 891, 896, 901, 906, 911, 916,
    921, 926, 931, 936, 941, 946, 951, 956, 961, 966, 971, 976,
    981, 986, 991, 996, 1001, 1006, 1011, 1016, 1021, 1026, 1031,
    1036, 1041, 1046, 1051, 1056, 1061, 1066, 1071, 1076, 1081,
    1086, 1091, 1096, 1101, 1106, 1111, 1116, 1121, 1126, 1131,
    1136, 1141, 1146, 1151, 1156, 1161, 1166, 1171, 1176, 1181,
    1186, 1191, 1196, 1201, 1206, 1211, 1216, 1221, 1226, 1231,
    1236, 1241, 1246, 1251, 1256, 1261, 1266, 1271, 1276, 1281,
    1286, 1291, 1296, 1301, 1306, 1311, 1316, 1321, 1326, 1331,
    1336, 1341, 1346, 1351, 1356, 1361, 1366, 1371, 1376, 1381,
    1386, 1391, 1396, 1401, 1406, 1411, 1416, 1421, 1426, 1431,
    1436, 1441, 1446, 1451, 1456, 1461, 1466, 1471, 1476, 1481,
    1486, 1491, 1496, 1501, 1502
  ],

  // Tier-specific proportions for iterative prediction (2025 band averages)
  tier_props: [
    { place: 1,    p1: 0.2967, p2: 0.3698, p3: 0.3032, p4: 0.0303 },
    { place: 35,   p1: 0.2942, p2: 0.3736, p3: 0.3035, p4: 0.0287 },
    { place: 100,  p1: 0.2888, p2: 0.3770, p3: 0.3058, p4: 0.0284 },
    { place: 250,  p1: 0.2851, p2: 0.3784, p3: 0.3088, p4: 0.0277 },
    { place: 450,  p1: 0.2822, p2: 0.3851, p3: 0.3053, p4: 0.0274 },
    { place: 600,  p1: 0.2933, p2: 0.3736, p3: 0.3055, p4: 0.0276 },
    { place: 750,  p1: 0.2890, p2: 0.3813, p3: 0.3028, p4: 0.0269 },
    { place: 1000, p1: 0.2834, p2: 0.3814, p3: 0.3090, p4: 0.0262 },
    { place: 1300, p1: 0.2807, p2: 0.3753, p3: 0.3180, p4: 0.0260 },
    { place: 1502, p1: 0.2656, p2: 0.3495, p3: 0.3564, p4: 0.0286 }
  ]
};

// Course checkpoint definitions (order matches race course)
// cumFn returns cumulative fraction of total time at each checkpoint
const CHECKPOINTS = [
  { key: "ts", label: "Top of Stairs", short: "Top Stairs", cumFn: (p) => p.p1 * D.sub.top_stairs_in_p1 },
  { key: "wg", label: "Windy Gap",   short: "W.Gap",    cumFn: (p) => p.p1 * D.sub.windy_gap_in_p1 },
  { key: "mw", label: "Muir Woods",  short: "Muir Wds", cumFn: (p) => p.p1 },
  { key: "dy", label: "Dynamite",    short: "Dynamite",  cumFn: (p) => p.p1 + p.p2 * D.sub.dynamite_in_p2 },
  { key: "bc", label: "Btm Cardiac", short: "Btm Card",  cumFn: (p) => p.p1 + p.p2 * D.sub.bottom_cardiac_in_p2 },
  { key: "ca", label: "Cardiac",     short: "Cardiac",   cumFn: (p) => p.p1 + p.p2 },
  { key: "sr", label: "SR Bridge",   short: "SR Bridge", cumFn: (p) => p.p1 + p.p2 + p.p3 * D.sub.steep_ravine_in_p3 },
  { key: "st", label: "Stile",       short: "Stile",     cumFn: (p) => p.p1 + p.p2 + p.p3 },
  { key: "fi", label: "Finish",      short: "Finish",    cumFn: (p) => 1.0 }
];
